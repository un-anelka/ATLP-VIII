<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Save and Load tests</title>
    <style>
        img {
            height: 200px;
            width: 200px;
            border: 2px solid black;
        }
    </style>
</head>

<body>

    Image Name <input type="text" id="namebox"> <br> <br>
    <img id="myimg"> <label id="UpProgress"></label><br><br>
    <button id="select">Select</button>
    <button id="retrieve">retrieve</button>
    <button id="upload">upload</button>


    <div class="blogAdmin">

    </div>


    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-database.js"></script>


    <script id="MainScript" type="module">
        import {
            getDatabase,
            set,
            ref,
            onValue,
        } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-database.js";

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
        //variables
        var ImgName, ImgUrl;
        var files = [];
        // var reader=new FileReader();

        // configuration of firebase 

        const firebaseConfig = {
            apiKey: "AIzaSyD8LxqcJ40-58DcRiSnG77MnqAw1DYDOm8",
            authDomain: "un-r-s-personal.firebaseapp.com",
            projectId: "un-r-s-personal",
            storageBucket: "un-r-s-personal.appspot.com",
            messagingSenderId: "871701200823",
            appId: "1:871701200823:web:982677c4cc95b0155bf232",
            // measurementId: "G-444SZGC124"
        };
        //initialization of firebase
        let app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const db = app.firestore();
        // const database= firebase.database();
        const database = getDatabase(initializeApp(firebaseConfig));

        let select = document.getElementById("select")
        select.addEventListener("click", (e) => {
            // e.preventDefault();
            var input = document.createElement("input");
            input.type = 'file';
            // input.click();

            input.addEventListener("change", (e) => {
                files = e.target.files;
                const reader = new FileReader();
                reader.addEventListener('load', () => document.getElementById("myimg").src = reader.result);
                reader.readAsDataURL(files[0])
            });

            input.click();
            //             db.collection("users").add({
            //     first: "Ada",
            //     last: "Lovelace",
            //     born: 1815
            // })
            // .then((docRef) => {
            //     console.log("Document written with ID: ", docRef.id);
            // })
            // .catch((error) => {
            //     console.error("Error adding document: ", error);
            // });
        })

        //Upload process
        document.getElementById("upload").onclick = function () {
            ImgName = document.getElementById("namebox").value;
            var uploadTask = firebase.storage().ref("Images_Test/" + ImgName + ".png").put(files[0]);


            uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, function (snapshot) {
                var percent = snapshot.bytesTransferred / snapshot.totalBytes * 100;
                console.log(percent + "% done");
                document.getElementById("UpProgress").innerHTML = `Upload ${percent} %`;
            },
                function (error) {
                    alert("error in saving image");
                },
                function () {
                    uploadTask.snapshot.ref.getDownloadURL().then(function (url) {
                        ImgUrl = url;
                        console.log("Hello mister", ImgUrl)

                        // });

                        firebase.database().ref("blogtest").push().set({

                            // database.ref("blogtest").set({
                            // firebase.firestore().ref("Pictures/"+ImgName).set({
                            // db.ref("Pictures/"+ImgName).set({
                            Name: ImgName,
                            Link: ImgUrl
                        });

                        alert("Image added successfully");
                    }

                    );

                }
            );
        }

        // retrieval Process from video

        // document.getElementById("retrieve").onclick=function(){
        //     ImgName=document.getElementById("namebox").value;
        //     firebase.database().ref("blogtest").on("value", function(snapshot){
        //         document.getElementById("myimg").src=snapshot.val().link;
        //     });
        // }

        // retrieval from Documentation
        document.getElementById("retrieve").onclick = function () {

            var retrieveFunc = firebase.database().ref('blogtest');
            retrieveFunc.on('value', (snapshot) => {
                const data = snapshot.val();
                // updateStarCount(postElement, data);
                // console.log("Hello UN", data);
                // console.log(data["-MwrHNMoyGqnpNVblENy"].Link)


                // for (var [key, value] of Object.entries(data)) {
                //     // console.log("data are here")
                //     // console.log(value, key)
                //     console.log(key)
                //     // console.log(value.Link)
                // }
 
                for (var [key, value] of Object.entries(data)) {
                    // console.log("data are here")
                    console.log(key, value)
                    // console.log(value.Name)
                    // console.log(value.Link)
                    // document.getElementById("myimg").src = value.Link;

                    const blogAdmin = document.querySelector(".blogAdmin")
                    const content_elt = document.createElement("div");
                    content_elt.innerHTML = `
                                            <div class="blog_image blog" data-id=${value.id}>
                                            <img src=${value.Link} alt="blog image blog" data-id=${value.Name}>
                                            <p>${value.Name}<p>
                                            </div>
                                            <h3 class="blog" data-id=${value.Name}> Hello Mister</h3>
                                            <p class="blog_title blog" data-id=${value.id}>lorem10</p>
                                            <p  data-id=${value.Name} class="readme_button blog">Read more..</p>
                                            `;

                    // content_elt.setAttribute("class", "blog_item");
                    // content_elt.setAttribute("data-id", value.id);

                    blogAdmin.append(content_elt);
                    
                    // window.location.href = "./html/blog.html";

                }
            });


        }


    </script>
</body>

</html>